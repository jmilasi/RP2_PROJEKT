<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Rezervacija</title>
    <link rel="stylesheet" type="text/css" media="all"
        href="jsDatePick_ltr.min.css" />
    <script type="text/javascript" src="jsDatePick.min.1.3.js"></script>
    <script src="jquery-2.1.4.min.js"></script>
    <link rel="stylesheet" type="text/css" href = "css/stil.css">


</head>

<body>   
    <div id="calendar"></div>

    <div id="predavaonice" align="center">
       
    </div>
    <h2 id = "tekst" align = "center"> </h2>
    <table id="raspored" align="center" style="visibility: hidden">
    </table>

    <script type="text/javascript">
        $(document).ready(function() {
            var date, room;
             var pred = "<table id = 'sobe'><tr><td>001</td><td>002</td><td>003</td></tr><tr><td>004</td><td>005</td><td>006</td></tr><tr><td>110</td><td>201</td><td>A101</td></tr></table>";
            globalObject = new JsDatePick({
                useMode: 1,
                isStripped: true,
                target: "calendar"
            });

            globalObject.setOnSelectedDelegate(function() {
            	$("#raspored").text(""); //obrise nam raspored prilikom klika na datum
            	$("#tekst").text(""); //obrsi što piše
                var obj = globalObject.getSelectedDay();
                date = obj.day + "." + obj.month + "." + obj.year + ".";
                var predavaonice = document.getElementById("predavaonice");
                predavaonice.innerHTML = pred;   //stvori nam tablicu predavaonica      
                
                tds = document.getElementsByTagName("td");
                for (var i = 0; i < tds.length; ++i)
                    tds[i].onclick = function() {  
                        room = this.innerHTML;
                        alert("Datum: " + date + "\n" + "Predavaonica: " +
                            room);
                        var fil = {datum: date, predavaonica: room};
                        console.log( fil );
                        document.getElementById("sobe").remove();  //obrise nam listu predavaonica kada kliknemo na njega.
                        $.ajax("raspored.php", {
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify(fil),
                            success: function(data) {
								//console.log(data[0]);
								
								if( typeof( data ) === "string" ) {
									alert( data);
									return;
								} 
								$("#tekst").text("Raspored predavaonice "+ room + " za datum: "+ date);
                                $("#raspored").text("");
                                $("#raspored").append(
                                    "<tr><th>SAT</th>" +
                                    "<th>IME KOLEGIJA</th>" +
                                    "<th>PREDAVAČ</th>" +
                                    "<th>Radnja</th></tr>");
                                var i = 8,j = 0;
                                var ponovi = 0;
                                while(i < 20) {

                                    if(j < data.length && data[j].SAT === i.toString()){ // i je tip number, a data[j].sat je string 
                                            var pamti = data[j].IME_KOLEGIJA;
                                            while(j+ponovi < data.length && pamti == data[j+ponovi].IME_KOLEGIJA) { ponovi++; i++; }
                                            if(data[j].DOZVOLA == 1)
                                            {
                                                $("#raspored").append(
                                                    "<tr><td>" + data[j].SAT + " - " + i.toString() + 
                                                    "</td><td>" + data[j].IME_KOLEGIJA +
                                                    "</td><td>" + data[j].PREDAVAC +
                                                    "</td><td>" + "<input type = 'button' name = 'ponisti' value = 'poništi rezervaciju'>" +
                                                    "</td></tr>");
                                            }
                                            else
                                            {
                                                $("#raspored").append(
                                                    "<tr><td>" + data[j].SAT + " - " + i.toString() + 
                                                    "</td><td>" + data[j].IME_KOLEGIJA +
                                                    "</td><td>" + data[j].PREDAVAC +
                                                    "</td><td>" + " " +
                                                    "</td></tr>");
                                            }
                                        j += ponovi;
                                        ponovi = 0;

                                    }
                                    else
                                    {                                                                                
                                        $("#raspored").append(
                                            "<tr><td>" + i + " - " + (i+1) + 
                                            "</td><td>" + "<textarea name='kolegij' placeholder='Kolegij..'></textarea>"+
                                            "</td><td>" + "<textarea name='predavac' placeholder='Predavač..'></textarea>"+
                                            "</td><td>" + "<input type = 'button' name = 'rezerviraj' value = 'rezerviraj'>"+
                                            "</td></tr>"); 
                                        i++;
                                    }
                                 
                                }
          

                                document.getElementById("raspored").style.visibility = "visible";
                                // rezerviraj predavaonicu:
                                var rez = document.getElementsByName("rezerviraj");
                                for( var i = 0; i < rez.length; ++ i){
                                    rez[i].onclick = function(event)
                                            {
                                                var td = event.target.parentNode;
                                                var tr = td.parentNode;
                                                var td1 = tr.children[0]; 
                                                var td2 = tr.children[1]; 
                                                var td3 = tr.children[2];
                                                var sat = td1.innerHTML;
                                                sat = sat.substring(0, sat.indexOf(' '));
                                                var predmet = td2.children[0].value;
                                                var predavac = td3.children[0].value;
                                                alert(sat + " " + predmet + " " + predavac );
                                            }   
                                }
                                //...............................................

                                //  ponisti rezervaciju
                                var pon = document.getElementsByName("ponisti");
                                for( var i = 0; i < pon.length; ++ i){
                                    pon[i].onclick = function(event)
                                            {
                                                var td = event.target.parentNode;
                                                var tr = td.parentNode;
                                                var td1 = tr.children[0]; 
                                                var td2 = tr.children[1]; 
                                                var td3 = tr.children[2];
                                                var sat = td1.innerHTML;
                                                sat = sat.substring(0, sat.indexOf(' '));
                                                var predmet = td2.innerHTML;
                                                var predavac = td3.innerHTML;
                                                alert(sat + " " + predmet + " " + predavac );
                                            }   
                                }

                                //...............................................
                            }
                        
                        });
                    }; 
            });
        });
    </script>
</body>

</html>
